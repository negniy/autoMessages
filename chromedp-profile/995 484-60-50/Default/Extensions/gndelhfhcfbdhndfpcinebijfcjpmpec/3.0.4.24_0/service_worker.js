!function(){"use strict";const t=new class{constructor(){this.data_=null}initialize(t){this.data_=t}get(t){if(!this.data_)throw new Error("Configuration is not initialized!");if(!Object.hasOwnProperty.call(this.data_,t))throw new Error(`Invalid configuration key! ${t}`);return this.data_[t]}};const e=new class{constructor(){this.data_=chrome.runtime.getManifest()}getVersion(t="."){return this.data_.version.split(".").join(t)}};var a,s,n;!function(t){t.CHROME="chrome",t.CHROMIUM="chromium",t.EDGE="edge",t.OPERA="opera",t.YABROWSER="yabrowser"}(a||(a={})),function(t){t.CHROME="Google Chrome",t.CHROMIUM="Chromium",t.EDGE="Microsoft Edge",t.OPERA="Opera",t.YANDEX="Yandex"}(s||(s={})),function(t){t.MAC="darwin",t.WINDOWS="winnt"}(n||(n={}));const r=new class{constructor(){this.userAgentBrands_=this.getUserAgentBrands_()}getUserAgentBrands_(){const t=new Set;if(navigator.userAgentData)for(const{brand:e}of navigator.userAgentData.brands)t.add(e);else{const{userAgent:e}=navigator;/YaBrowser/.test(e)&&t.add(s.YANDEX),/OPR\//.test(e)&&t.add(s.OPERA),/Edg\//.test(e)&&t.add(s.EDGE),/Chrome/.test(e)&&!/MRCHROME|Comodo/.test(e)&&t.add(s.CHROME),/Chromium/.test(e)&&t.add(s.CHROMIUM)}return t}getUserAgent(){return this.userAgentBrands_.has(s.YANDEX)?a.YABROWSER:this.userAgentBrands_.has(s.OPERA)?a.OPERA:this.userAgentBrands_.has(s.EDGE)?a.EDGE:this.userAgentBrands_.has(s.CHROME)?a.CHROME:this.userAgentBrands_.has(s.CHROMIUM)?a.CHROMIUM:null}getOS(){const t=navigator.userAgentData?navigator.userAgentData.platform:window.navigator.platform,e=t.toLocaleLowerCase();return e.startsWith("win")?n.WINDOWS:e.startsWith("mac")?n.MAC:t}},i="https://yandex.ru/clck/click";var o,c;!function(t){t.CLIENT="690.2354",t.EXTERNAL="690.2854",t.SCRIPT="690.2609",t.UNCAUGHT="690.2361"}(o||(o={})),function(t){t.CRITICAL="critical",t.DEBUG="debug",t.ERROR="error",t.INFO="info",t.TRACE="trace",t.WARN="warn"}(c||(c={}));const l=new class{async uncaught(t){const e=this.getVars_(t,c.CRITICAL);await fetch(i,{method:"POST",body:`/path=${o.UNCAUGHT}/vars=${e}/*`})}async info(t){const e=this.getVars_(t,c.INFO);await fetch(i,{method:"POST",body:`/path=${o.CLIENT}/vars=${e}/*`})}getVars_(a,s){const n={msg:a,level:s,project:t.get("errorboosterProject"),service:t.get("yasoft"),timestamp:Date.now(),version:e.getVersion(),useragent:r.getUserAgent()};return Object.keys(n).filter((t=>n[t])).map((t=>`-${t}=${encodeURIComponent(n[t])}`)).join(",")}};class d{constructor(t){this.response_=t,this.ok=this.response_.ok}async text(){return this.response_.text()}}class u{constructor(t){this.url_=new URL(t)}async run(){return new d(await fetch(this.url_.toString()))}}const h=new class{constructor(t){this.baseParams_=t}async send(t){const e=Object.assign(Object.assign({},this.baseParams_),t),a=this.buildUrl_(e);(await new u(a).run()).ok?console.log("Clicker statistics sent:",a):console.log("Clicker statistics error:",a)}buildUrl_(e){const a=e.path||["platform","feature","version","action"].map((t=>e[t])).filter(Boolean).join(".");return t.get("clickerUrl").replace("{pid}",encodeURIComponent(e.pid)).replace("{cid}",encodeURIComponent(e.cid)).replace("{path}",encodeURIComponent(a)).replace("{vars}","")}}({pid:12,cid:72359,platform:r.getUserAgent(),version:e.getVersion().split(".").join("-")});const g=new class{run(){chrome.action.onClicked.addListener((()=>{const e=new URL(t.get("portalUrl"));console.log("Opening portal",e.toString()),chrome.tabs.create({url:e.toString()}),h.send({pid:12,cid:72975,platform:null,feature:t.get("yasoft"),action:"icon"})}))}};var m;!function(t){t.APPLICATION_UID="application.ui",t.BANNER_ID="application.banner.id",t.EXPERIMENTS="application.experiments",t.INSTALL_DATE="application.installDate",t.IS_YANDEX_UI="yandex.statistics.is-yandex-ui",t.NTP_COOKIE_SET_TIME="ntp.cookie.set.time",t.PRESET_DATE="yandex.statistics.presetDate",t.SOFT_EXPORT_TIME="yandex.statistics.time",t.STATISTICS_UID="yandex.statistics.ui",t.TIME="yandex.statistics.time",t.UPDATE_DATE="application.updateDate",t.VERSION="application.version",t.YANDEX_STATISTICS_UID="yandex.statistics.yandexUi",t.CLID_1="yandex.statistics.clid.1",t.CLID_5="yandex.statistics.clid.5",t.CLID_6="yandex.statistics.clid.6",t.CLID_7="yandex.statistics.clid.7",t.CLID_8="yandex.statistics.clid.8",t.CLID_9="yandex.statistics.clid.9",t.CLID_11="yandex.statistics.clid.11",t.CLID_12="yandex.statistics.clid.12",t.CLID_14="yandex.statistics.clid.14",t.CLID_15="yandex.statistics.clid.15",t.CLID_17="yandex.statistics.clid.17",t.CLID_18="yandex.statistics.clid.18",t.CLID_20="yandex.statistics.clid.20",t.CLID_21="yandex.statistics.clid.21",t.CLID_23="yandex.statistics.clid.23",t.CLID_28="yandex.statistics.clid.28",t.CLID_29="yandex.statistics.clid.29",t.CLID_30="yandex.statistics.clid.30"}(m||(m={}));class _{constructor(){this.promise=new Promise(((t,e)=>{this.resolve_=t,this.reject_=e}))}resolve(){this.resolve_()}reject(){this.reject_()}}const p=new class{constructor(){this.initializeDeferred_=new _}async tryInitialize(t){void 0!==(await chrome.storage.local.get(t))[t]&&this.initializeDeferred_.resolve()}async get(t){return await this.initializeDeferred_.promise,(await chrome.storage.local.get(t))[t]}async set(t,e){return chrome.storage.local.set({[t]:e})}async setDate(t,e){let a=e.getTime();switch(t){case m.INSTALL_DATE:case m.UPDATE_DATE:case m.SOFT_EXPORT_TIME:a/=1e3}await this.set(t,a)}async getDate(t){const e=await this.get(t);if("number"==typeof e)switch(t){case m.INSTALL_DATE:case m.UPDATE_DATE:case m.SOFT_EXPORT_TIME:return new Date(1e3*e);default:return new Date(e)}}};class y{constructor(){this.tab_=null,this.initPromise_=this.initTab_()}async initTab_(){const t=await chrome.tabs.query({});this.tab_=this.findTab_(t)}async getParams(){return await this.initPromise_,this.tab_?new URL(this.tab_.url).searchParams:null}}const w=new class extends y{findTab_(t){var e;return null!==(e=t.find((t=>t.url.startsWith("https://chromewebstore.google.com/detail/")&&t.url.indexOf(chrome.runtime.id)>0)))&&void 0!==e?e:null}},x="banerid";const I=new class{async readFromWebstoreTab(){const t=await w.getParams();if(t&&t.has(x)){const e=t.get(x);return await p.set(m.BANNER_ID,e),e}return null}async getValue(){let t=await p.get(m.BANNER_ID);return t||(t||(t=await this.readFromWebstoreTab()),null!=t?t:null)}};const D=new class{async get(e){return m[`CLID_${e}`]&&(await p.get(m[`CLID_${e}`])||t.get(`clid${e}`))||""}},f=(t=new Date,e=3)=>{const a=t.getHours()<e?t.getDate()-1:t.getDate();return new Date(t.getFullYear(),t.getMonth(),a,e)},S=t=>{const e=f(t);return Math.floor((Date.now()-e.getTime())/864e5)},T="http://chrome-elements.yandex.addons/";const E=new class{async get(t){const e={url:T,name:t},a=await chrome.cookies.get(e);return(null==a?void 0:a.value)?this.getValue_(a.value):void 0}set(t,e){const a={url:T,name:t,value:this.processValue_(e),expirationDate:Math.floor((Date.now()+15768e7)/1e3)};chrome.cookies.set(a)}processValue_(t){return"object"==typeof t?encodeURIComponent(JSON.stringify(t)):"string"==typeof t?encodeURIComponent(t):String(t)}getValue_(t){let e=decodeURIComponent(t);try{e=JSON.parse(e)}catch(t){}return e}},C="yandex.statistics.ui";const A=new class{async getValue(){const t=await E.get(C),e=await p.get(m.YANDEX_STATISTICS_UID)||await p.get(m.APPLICATION_UID);let a="string"==typeof t?t:e;return a||(a=this.generateValue_()),a&&"string"!=typeof t&&E.set(C,a),a&&!e&&await p.set(m.APPLICATION_UID,a),a}generateValue_(){return"{xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx}".split("").map((t=>"x"!==t?t:"0123456789ABCDEF"[Math.floor(16*Math.random())])).join("")}};const U=new class{run(){chrome.runtime.onInstalled.addListener((t=>{"install"===t.reason&&this.setGoodbyePage_()}))}async setGoodbyePage_(){const a={yasoft:t.get("yasoftChr"),ui:await A.getValue(),gchid:chrome.runtime.id,bnrd:await I.getValue(),ver:e.getVersion(),os:r.getOS(),stat:"uninstall",brandID:t.get("brandId"),clid:await D.get(1),dateinstall:(s=await p.getDate(m.INSTALL_DATE),`${String(s.getDate()).padStart(2,"0")}.${String(s.getMonth()+1).padStart(2,"0")}.${s.getFullYear()}`)};var s;const n=new URL(t.get("goodbyeUrl"));for(const t in a)a[t]&&n.searchParams.set(t,a[t]);const i=["bnrd","gchid","brandID","ver","os"];for(;n.toString().length>255&&i.length;)n.searchParams.delete(i.pop());try{await chrome.runtime.setUninstallURL(n.toString()),console.log("Set uninstall URL",n.toString())}catch(t){console.error("Failed to set goodby URL:",n.toString(),t.message)}}};const b=new class{run(){chrome.runtime.onInstalled.addListener((async t=>{"install"===t.reason&&(await I.readFromWebstoreTab(),await p.setDate(m.INSTALL_DATE,new Date),this.initStorage_()),"update"===t.reason&&await p.setDate(m.UPDATE_DATE,new Date)})),this.initStorage_()}initStorage_(){p.tryInitialize(m.INSTALL_DATE)}},L=["https://yandex.{tld}/chrome/newtab/","https://www.yandex.{tld}/chrome/newtab/"],R=["ru","ua","by","kz","com.tr"],v=36e5,O="ntp_cookie_alarm";const P=new class{run(){chrome.runtime.onInstalled.addListener((t=>{"install"===t.reason&&this.updateCookies_()})),chrome.alarms.onAlarm.addListener((t=>{t.name===O&&this.updateCookies_()}))}scheduleNextUpdate_(){chrome.alarms.create(O,{delayInMinutes:Math.floor(60)})}async updateCookies_(){const t="ext-"+chrome.runtime.id,e=JSON.stringify({id:await p.get(m.INSTALL_DATE),ud:await p.get(m.UPDATE_DATE),t:Date.now(),d:{clid:await D.get(6),from:"chromesearch"}});for(const a of L)for(const s of R)await chrome.cookies.set({url:a.replace("{tld}",s),name:t,value:e,expirationDate:Math.floor((Date.now()+v)/1e3)});await p.setDate(m.NTP_COOKIE_SET_TIME,new Date),this.scheduleNextUpdate_()}};const M=new class{async send(){const e=t.get("dayuseStatUrl").replace("{vars}",await this.getVars_()).replace("{slots}",await this.getSlots_());new u(e).run(),console.log("Day use statistics sent:",e)}async getVars_(){const a=await p.getDate(m.INSTALL_DATE),s={dayuse:String(S(a)),bro:r.getUserAgent(),productname:t.get("yasoft"),ver:e.getVersion().split(".").join("-"),ui:await A.getValue(),brandID:t.get("brandId"),clid1:await D.get(1),bnrd:await I.getValue(),gchid:chrome.runtime.id};return Object.keys(s).filter((t=>s[t])).map((t=>`-${t}=${encodeURIComponent(s[t])}`)).join(",")}async getSlots_(){const t=await p.get(m.EXPERIMENTS);let e=[0,0,0];if(Array.isArray(t)){const a=t[0];a&&(e=[a.testId,a.testId,a.bucket])}return e.map(encodeURIComponent).join(",")}};var N;!function(t){t.INSTALL="install",t.DAY_USE="dayuse"}(N||(N={}));const k=new class{async send(a){var s={yasoft:t.get("yasoftChr"),ui:await A.getValue(),ver:e.getVersion(),os:r.getUserAgent(),stat:a,brandID:t.get("brandId"),clid:await D.get(1),bnrd:await I.getValue(),gchid:chrome.runtime.id};const n=new URL(t.get("softExportUrl"));for(const t in s)Object.hasOwnProperty.call(s,t)&&s[t]&&n.searchParams.set(t,s[t]);await new u(n.toString()).run(),console.log("Soft export statistics sent:",n.toString())}},V="statistics_alarm";const j=new class{run(){chrome.runtime.onInstalled.addListener((t=>{"install"===t.reason?(this.scheduleDailyUsageSend_(1),l.info("install")):"update"===t.reason&&l.info("update")})),chrome.alarms.onAlarm.addListener((async t=>{t.name===V&&this.sendDailyiUsageStats_()}))}scheduleDailyUsageSend_(t){chrome.alarms.create(V,{delayInMinutes:t})}async sendDailyiUsageStats_(){const t=await p.getDate(m.SOFT_EXPORT_TIME);this.checkCanSend(t)&&(await p.setDate(m.SOFT_EXPORT_TIME,new Date),await k.send(t?N.DAY_USE:N.INSTALL),await M.send()),this.scheduleDailyUsageSend_(15)}checkCanSend(t){return!t||(!(t instanceof Date)||(!!isNaN(t.getTime())||f().getTime()>t.getTime()))}};const Y=new class extends y{findTab_(e){var a;const s=t.get("tld"),n=`https://yandex.${s}/promo/set/`,r=`https://yandex.${s}/promo/set/welcome`;return null!==(a=e.find((t=>t.url.startsWith(n)&&!t.url.startsWith(r))))&&void 0!==a?a:null}};const $=new class{async run(){chrome.runtime.onInstalled.addListener((t=>{"install"===t.reason&&this.openWelcome_()}))}async openWelcome_(){const e=new URL(t.get("welcomeUrl"));await this.addTabParams_(e,w,"w"),await this.addTabParams_(e,Y,"l"),e.searchParams.set("gchid",chrome.runtime.id),console.log("Opening welcome",e.toString()),chrome.tabs.create({url:e.toString()}),h.send({pid:12,cid:72975,platform:null,feature:t.get("yasoft"),action:"welcome-open"})}async addTabParams_(t,e,a){const s=await e.getParams();if(!s)return void t.searchParams.set(a,"-1");let n=0;for(const[e,a]of s)t.searchParams.has(e)||(t.searchParams.set(e,a),n+=1);t.searchParams.set(a,String(n))}},B="context-menu-search";const W=new class{run(){const e=t.get("ctxSearchUrl");e&&(chrome.runtime.onInstalled.addListener((t=>{this.removeContextMenu_(),this.createContextMenu_()})),chrome.contextMenus.onClicked.addListener((t=>{t.menuItemId===B&&this.openSearchTab_(t,e)})))}removeContextMenu_(){chrome.contextMenus.removeAll()}createContextMenu_(){const e=t.get("ctxSearchUrl");chrome.contextMenus.create({title:t.get("ctxSearchMessage"),contexts:this.getSearchContext_(e),id:B})}openSearchTab_(t,e){var a;if((null==t?void 0:t.selectionText)||(null==t?void 0:t.srcUrl)){const s=null!==(a=null==t?void 0:t.srcUrl)&&void 0!==a?a:"",n=this.clearText_(null==t?void 0:t.selectionText),r=e.replace("__SRC_URL__",s).replace("__QUERY__",n);chrome.tabs.create({url:r})}}getSearchContext_(t){return t.includes("__SRC_URL__")?["image"]:["selection"]}clearText_(t=""){const e=" ,/?:@&=+$#;%";t=t.replace(/( ){1,}/g," ");for(let a=e.length-1;a>=0;a--){const s=new RegExp("(\\"+e[a]+")","ig");t=t.replace(s,encodeURIComponent(e[a]))}return t.length>301?t.substring(0,300):t}};function F(t){try{return decodeURIComponent(t)}catch(e){return t}}var H=function(t){if(!t||"string"!=typeof t||!t.length)return{};/%23\d{10}/.test(t)&&(t=F(t)),t=t.split("#");for(var e,a=Date.now()/1e3,s={},n=0,r=t.length;n<r;n++)2===(e=t[n].split(".")).length?s[e[0]]=F(e[1]):e.length>2&&(isNaN(e[0])?s[e[0]]=F(e.slice(1).join(".")):e[0]>a&&(s[e[1]]={value:F(e.slice(2).join(".")),expires:new Date(+(e[0]+"000"))}));return s},X=function(t){if(t&&"object"==typeof t){for(var e,a,s=[],n=0,r=Object.keys(t),i=r.length;n<i;n++)e=t[r[n]],a=[r[n],encodeURIComponent(e.value||e)],/\d+/.test(e.expires)&&a.unshift(e.expires),s.push(a.join("."));return s.join("#")}};const z=["https://yandex.ru/","https://yandex.kz/","https://yandex.ua/","https://yandex.by/","https://yandex.uz/","https://yandex.net/","https://yandex.com/","https://yandex.com.tr/","https://ya.ru/"],G="ys_cookie_alarm";const J={brandId:"yandex",tld:"ru",clid1:"2865315",clid6:"2877288",yasoft:"searchextchrome",yasoftChr:"searchextchrome_chr",clickerUrl:"https://yandex.ru/clck/click/dtype=stred/pid={pid}/cid={cid}/path={path}{vars}/*",dayuseStatUrl:"https://yandex.ru/clck/click/dtype=elduse/path=tech.yaelements.dayuse/vars={vars}/slots={slots}/*",softExportUrl:"https://soft.export.yandex.ru/status.xml",portalUrl:"https://ya.ru/?clid=2877288",welcomeUrl:"https://browser.yandex.ru/tools/redirect/ext_n?app=search",goodbyeUrl:"https://yandex.ru/soft/extensions/goodbye",errorboosterProject:"homesearch"},K=[b,$,U,g,P,j,new class{run(){chrome.runtime.onInstalled.addListener((t=>{"install"===t.reason&&this.updateYSCookies_()})),chrome.alarms.onAlarm.addListener((t=>{t.name===G&&this.updateYSCookies_()}))}scheduleNextYSCookieUpdate_(){chrome.alarms.create(G,{delayInMinutes:60})}async updateYSCookies_(){for(const a of z){const s=await chrome.cookies.get({name:"ys",url:a}),n=s?H(s.value):{};n[t.get("yasoft")]=e.getVersion("-"),await chrome.cookies.set({url:a,name:"ys",value:X(n),secure:!0}),console.log("YS cookie is set for",a,n)}this.scheduleNextYSCookieUpdate_()}}];J.ctxSearchUrl=chrome.i18n.getMessage("ctxSearchUrlVideo"),J.ctxSearchMessage=chrome.i18n.getMessage("ctxSearchMessageVideo"),K.push(W),t.initialize(J),self.addEventListener("error",(t=>{l.uncaught(t.message)})),self.addEventListener("unhandledrejection",(t=>{l.uncaught(t.reason)}));for(const t of K)t.run()}();
